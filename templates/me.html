{!extends file='layout.html'!} {!block name=main!}
<link href="/lib/bootstrap-datepicker/datepicker3.css" rel="stylesheet">
<link rel="stylesheet"
	href="/lib/umeditor/themes/default/css/umeditor.css">
<script src="/lib/bootstrap-datepicker/bootstrap-datepicker.js"></script>

<script type="text/javascript" src="/lib/umeditor/umeditor.config.js"></script>
<script type="text/javascript" src="/lib/umeditor/umeditor.min.js"></script>
<script type="text/javascript" src="/lib/umeditor/lang/zh-cn/zh-cn.js"></script>
<script>
	require(['angular', 'angular-route', 'angular-resource'], function(angular,
			angular_route, $resource) {
		var app = angular.module('me', ['ngRoute', 'ngResource']).config(
				['$routeProvider', function($routeProvider) {
					$routeProvider.when('/info', {
						templateUrl: 'tpl/me/info.html',
						controller: 'info'
					}).when('/project', {
						templateUrl: 'tpl/me/project.html',
						controller: 'project'
					}).when('/project/:project_id', {
						templateUrl: 'tpl/me/project-edit.html',
						controller: 'project-edit'
					}).when('/team', {
						templateUrl: 'tpl/me/team.html',
						controller: 'team'
					}).when('/team/:team_id', {
						templateUrl: 'tpl/me/team-detail.html',
						controller: 'team-detail'
					}).when('/message', {
						templateUrl: 'tpl/me/message.html',
						controller: 'message'
					}).otherwise({
						redirectTo: '/'
					});
				}]);
		app.controller('info', function($scope, $resource) {
			var User = $resource(API + 'user/:userId', {userId:'@id'}, {save: {method: 'PUT'}});
			var user = User.get({
				userId: localStorage.uid
			});
			$scope.user = user;
			$scope.save = function(){
				user.$save(function(){
					localStorage.user = JSON.stringify(user);
					alert("修改成功");
					location.reload();
				});
				
			};
			var School = $resource(API + 'school');
			$scope.schools = School.query();
			var Major = $resource(API + 'major');
			$scope.majors = Major.query();
		});
		app.controller('project', function($scope, $resource) {
			var Project = $resource(API + 'user/:user_id/type/:type/project');
			$scope.joined = Project.query({
				user_id: localStorage.uid,
				type: 'joined'
			});
			$scope.created = Project.query({user_id: localStorage.uid, type: 'created'});
		});
		app.controller('team-detail', function($scope, $resource, $routeParams) {
			var Team = $resource(API + 'team/:team_id',{team_id: '@team_id'},{save: {method: 'PUT'}});
			
			var team = Team.get({
				team_id: $routeParams.team_id
			}, function() {
				$scope.team = team;
				$scope.team.created_at = team.created_at.substr(0, 10);
			});
			
			$scope.update = function(){
				$scope.team.$save(function(){
					alert("保存成功");
				});
			};
			var Status = $resource(API + 'team/:team_id/user/:user_id/status', {team_id: '@team_id', user_id: '@user_id'}, {save: {method: 'PUT'}});
			$scope.permit = function(user_id){
				var status = Status.get({
					team_id: $routeParams.team_id,
					user_id: user_id
				});
				status.status = "permited";
				status.$save(function(){
					alert("修改成功");
				})
			};
			$scope.deny = function(user_id){
				var status = Status.get({
					team_id: $routeParams.team_id,
					user_id: user_id
				});
				status.status = "denied";
				status.$save(function(){
					alert("修改成功");
				})
			};
			$scope.remove = function(user_id){
				var status = Status.get({
					team_id: $routeParams.team_id,
					user_id: user_id
				});
				status.status = "removed";
				status.$save(function(){
					alert("修改成功");
				})
			}
		});
		app.controller('project-edit', function($scope, $resource, $routeParams) {
			var um;
			var Project = $resource(API + 'project/:project_id',{project_id: '@id'}, {save: {method: 'PUT'}});
			$scope.project = Project.get({
				project_id: $routeParams.project_id,
			}, function(){
				$scope.project.deadline = $scope.project.deadline.substr(0, 10);
				um = UM.getEditor('dsc', {
					autoFloatEnabled: false
				});
				um.ready(function(){
					um.setContent($scope.project.description);
				});
				
				$scope.selcates = $scope.project.categorys;
				var Cate = $resource(API + 'category');
				$scope.cates = Cate.query({}, function(){
					for(var i in $scope.cates){
						for(var k in $scope.cates[i].children){
						for(var j in $scope.project.categorys){
							if($scope.project.categorys[j].id == $scope.cates[i].children[k].id){
								$scope.cates[i].children[k].select = true;
							}
						}
						}
					}
				});
			});
			var getCates = function(){
				var cates = [];
				for(var i in $scope.cates){
					var cate = $scope.cates[i].children;
					for(var j in cate){
						if(cate[j].select){
							cates.push(cate[j]);
						}
					}
				}
				$scope.selcates = cates;
				return cates;
			}
			$scope.create = function() {
				$scope.project.description = um.getContent();
				var categorys = getCates();
				$scope.project.categorys = [];
				for(var i in categorys){
					$scope.project.categorys.push(categorys[i].id);
				}
				$scope.project.$save(function(){
					alert("保存成功");
				});
			};
			
			$scope.select = function($event, cate){
				var checkbox = $event.target;
				cate.select = checkbox.checked?true:false;
				getCates();
			}
			
		});
		app.controller('team', function($scope, $resource) {
			var Team = $resource(API + 'user/:user_id/team')
			var teams = Team.query({
				user_id: localStorage.uid
			}, function() {
				$scope.teams = teams;
			})
		});
		app.controller('sidebar', function($scope, $resource) {
			var User = $resource(API + 'user/:user_id')
			$scope.user = User.get({
				user_id: localStorage.uid
			});
			$scope.logout = function(){
				localStorage.removeItem("uid");
				localStorage.removeItem("accesstoken");
				location.href="/scanproject";
			}
		});
		app.controller('message', function($scope, $resource) {
			var User = $resource(API + 'user/:user_id')
			$scope.user = User.get({
				user_id: localStorage.uid
			});
		});
		
		angular.bootstrap(document.getElementById("body"), ['me']);
	});
</script>

<div class="me">
	<div class="row">
		<div class="col-md-2" ng-controller="sidebar">
			<div class="avatar clearfix">
				<img class="img-thumbnail" alt="140x140"
					src="/img/avatar.png"
					data-holder-rendered="true">
				<div ng-bind="user.realname"></div>
			</div>
			<div class="list-group">
				<a href="#project" class="list-group-item"><span
					class="glyphicon glyphicon-th-list"></span> 我的项目</a> <a
					href="#team" class="list-group-item"><span
					class="glyphicon glyphicon-tower"></span> 我的团队</a> <a href="#info"
					class="list-group-item"><span class="glyphicon glyphicon-user"></span>
					个人信息</a> <a href="#message" class="list-group-item"><span
					class="glyphicon glyphicon-envelope"></span> 消息通知</a> <a href="#" ng-click="logout()"
					class="list-group-item"><span class="glyphicon glyphicon-off"></span>
					退出</a>
			</div>
		</div>
		<div class="col-md-10">
			<div ng-view></div>
		</div>
	</div>
</div>
{!/block!}
